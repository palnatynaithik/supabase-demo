<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduTrack - Reset Password</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body class="bg-[var(--bg-light)] flex items-center justify-center min-h-screen">

<div class="bg-white shadow-xl rounded-2xl p-10 w-96">
  <h1 class="text-3xl font-semibold mb-6 text-[var(--primary-blue)] text-center">Reset Your Password</h1>

  <input type="password" id="newPassword" placeholder="New Password"
    class="w-full mb-4 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--primary-light)] text-base">
  <input type="password" id="confirmPassword" placeholder="Confirm Password"
    class="w-full mb-4 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--primary-light)] text-base">

  <button id="resetBtn"
    class="w-full bg-[var(--primary-light)] hover:bg-[var(--primary-blue)] text-white px-4 py-3 rounded-xl font-medium transition">Reset Password</button>

  <p id="message" class="mt-4 text-center text-sm text-red-500"></p>
</div>

<script type="module">
import { supabase } from './supabaseClient.js'

const resetBtn = document.getElementById('resetBtn')
const newPassword = document.getElementById('newPassword')
const confirmPassword = document.getElementById('confirmPassword')
const message = document.getElementById('message')

// Grab access_token from URL
const params = new URLSearchParams(window.location.hash.slice(1))
const accessToken = params.get('access_token')

if(!accessToken){
  message.textContent = "Invalid or expired link."
}

resetBtn.addEventListener('click', async () => {
  if(newPassword.value !== confirmPassword.value){
    message.textContent = "Passwords do not match!"
    return
  }

  try {
    // Update password using the magic link token
    const { data, error } = await supabase.auth.updateUser(
      { password: newPassword.value },
      { access_token: accessToken }
    )
    if(error) throw error

    // âœ… Password updated, now redirect based on role
    const { data: userData, error: userError } = await supabase.auth.getUser()
    if(userError) throw userError

    const userId = userData.user.id

    // Check which role table this user exists in
    const { data: student } = await supabase.from('students').select('*').eq('id', userId).single()
    const { data: teacher } = await supabase.from('teachers').select('*').eq('id', userId).single()
    const { data: parent } = await supabase.from('parents').select('*').eq('id', userId).single()
    const { data: admin } = await supabase.from('admins').select('*').eq('id', userId).single()

    if(admin) window.location.href = 'dashboard_admin.html'
    else if(teacher) window.location.href = 'dashboard_teacher.html'
    else if(student) window.location.href = 'dashboard_student.html'
    else if(parent) window.location.href = 'dashboard_parent.html'
    else message.textContent = "Role not found! Contact admin."

  } catch(err) {
    console.error(err)
    message.textContent = "Failed to reset password."
  }
})

</script>

</body>
</html>
